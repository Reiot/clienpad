<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css" />
<script src="http://code.jquery.com/jquery-1.5.2.min.js"></script>
<script src="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.js"></script>

<style type="text/css">
	.ui-li-has-thumb .ui-btn-inner a.ui-link-inherit, .ui-li-static.ui-li-has-thumb {
		min-height: 0;
		padding-left: 85px;
	}
	img.ppan {
		display: block;
		margin: 11px 11px 11px 11px;
	}
	img.ppan.default {
		display: none;
		opacity: 0.7;
	}
	span.author {
		display: block;
		position: absolute;
		left: 4px;
		top: 11px;
		width: 70px;
		font-size: 10px;
		text-align: center;
		background-color: #ccc;
		padding: 2px;
		color: black;
	}
</style>
<!-- Start of first page -->
<div data-role="page" id="foo">
    
    <div data-role="header" data-theme="d">
        <h1>jClien</h1>
    </div><!-- /header -->
    
    <div data-role="content" data-theme="d">    
        <ul id="posts" data-role="listview">
			{% for post in posts %}
			<li>
				{{post.author}}
				<a href="/{{board}}/{{post.id}}">
					{{post.title}}
					<span class="ui-li-aside ui-li-desc">{{post.publish_time_short}}</span>					
				</a>
				{% if post.comments %}
				<span class="ui-li-count">{{post.comments}}</span>
				{% endif %}
			</li>
			{% endfor %}        	
        </ul>
	    <div style="margin-top: 2em;">
	        <a href="#" id="more" data-role="button" data-icon="refresh" data-board="{{board}}" data-next-page="{{next_page}}">More</a>
	    </div><!-- /header -->
    </div><!-- /content -->
    
</div><!-- /page -->

<script type="text/javascript">
$(function(){
	$('#more').click(function(){
		var $button = $(this),
			board = $button.data('board'),
			nextPage = $button.data('next-page');
			
		console.log('board', board, 'nextPage', nextPage);
		
		$.getJSON("/"+board+"/page"+nextPage, { format: "json" })
			.success(function(response){
				console.log('response',response);
				
				$button.data('next-page', response.next_page);
				var i;
				var $posts = $('#posts');
				for( i = 0 ; i < response.posts.length ; i ++ ){
					var post = response.posts[i];
					var li = '<li>'
					+ post.author
					+ '<a href="/' + board + '/' + post.id + '">' 
					+ post.title 
					+ '<span class="ui-li-aside ui-li-desc">' + post.publish_time_short + '</span>'
					+ '</a>';
					if(post.comments>0){
						li += '<span class="ui-li-count">' + post.comments + '</span>';
					}					
					li += '</li>';					
					
					$posts.append(li);
				}
				$posts.listview('refresh');
			});
	});
});
</script>

